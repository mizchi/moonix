// Generated by moon-component
// Import module: wasi:sockets/udp@0.2.9

type ErrorCode = @network.ErrorCode

type IpSocketAddress = @network.IpSocketAddress

type IpAddressFamily = @network.IpAddressFamily

///|
pub(all) struct IncomingDatagram {
  data : Array[Byte]
  remote_address : IpSocketAddress
} derive(Show, Eq)

///|
pub(all) struct IncomingDatagramStream(Int) derive(Show, Eq)

///|
pub(all) struct OutgoingDatagram {
  data : Array[Byte]
  remote_address : IpSocketAddress?
} derive(Show, Eq)

///|
pub(all) struct OutgoingDatagramStream(Int) derive(Show, Eq)

///|
pub(all) struct UdpSocket(Int) derive(Show, Eq)

///| Low-level FFI import
fn ffi_incoming_datagram_stream_receive(p0 : Int, p1 : Int64, retptr : Int) -> Int = "wasi:sockets/udp@0.2.9" "[method]incoming-datagram-stream.receive"

///| High-level wrapper with canonical ABI conversion
pub fn incoming_datagram_stream_receive(handle : IncomingDatagramStream, max_results : UInt64) -> Result[Array[IncomingDatagram], ErrorCode] {
  let retptr = @cabi.cabi_realloc(0, 0, 4, 12)
  let _ = ffi_incoming_datagram_stream_receive(handle.0, max_results.reinterpret_as_int64(), retptr)
  match @cabi.cabi_read_i32(retptr) {
    0 => {
      // TODO: lift Array[IncomingDatagram] properly
      Ok([])
    }
    _ => Err(ErrorCode::from_ordinal(@cabi.cabi_read_i32(retptr + 4)))
  }
}

///| Low-level FFI import
fn ffi_incoming_datagram_stream_subscribe(p0 : Int) -> Int = "wasi:sockets/udp@0.2.9" "[method]incoming-datagram-stream.subscribe"

///| High-level wrapper with canonical ABI conversion
pub fn incoming_datagram_stream_subscribe(handle : IncomingDatagramStream) -> @poll.Pollable {
  let result = ffi_incoming_datagram_stream_subscribe(handle.0)
  @poll.Pollable(result)
}

///| Low-level FFI import
fn ffi_outgoing_datagram_stream_check_send(p0 : Int, retptr : Int) -> Int = "wasi:sockets/udp@0.2.9" "[method]outgoing-datagram-stream.check-send"

///| High-level wrapper with canonical ABI conversion
pub fn outgoing_datagram_stream_check_send(handle : OutgoingDatagramStream) -> Result[UInt64, ErrorCode] {
  let retptr = @cabi.cabi_realloc(0, 0, 4, 12)
  let _ = ffi_outgoing_datagram_stream_check_send(handle.0, retptr)
  match @cabi.cabi_read_i32(retptr) {
    0 => Ok(@cabi.cabi_read_i64(retptr + 4).reinterpret_as_uint64())
    _ => Err(ErrorCode::from_ordinal(@cabi.cabi_read_i32(retptr + 4)))
  }
}

///| Low-level FFI import
fn ffi_outgoing_datagram_stream_send(p0 : Int, p1_ptr : Int, p1_len : Int, retptr : Int) -> Int = "wasi:sockets/udp@0.2.9" "[method]outgoing-datagram-stream.send"

///| High-level wrapper with canonical ABI conversion
pub fn outgoing_datagram_stream_send(handle : OutgoingDatagramStream, datagrams : Array[OutgoingDatagram]) -> Result[UInt64, ErrorCode] {
  let p1_len = datagrams.length()
  let p1_ptr = @cabi.cabi_realloc(0, 0, 4, p1_len * 16)
  for i, _elem in datagrams {
    let _elem_ptr = p1_ptr + i * 16
    // TODO: lower nested type elem.data
    // TODO: lower nested type elem.remote_address
  }
  let retptr = @cabi.cabi_realloc(0, 0, 4, 12)
  let _ = ffi_outgoing_datagram_stream_send(handle.0, p1_ptr, p1_len, retptr)
  match @cabi.cabi_read_i32(retptr) {
    0 => Ok(@cabi.cabi_read_i64(retptr + 4).reinterpret_as_uint64())
    _ => Err(ErrorCode::from_ordinal(@cabi.cabi_read_i32(retptr + 4)))
  }
}

///| Low-level FFI import
fn ffi_outgoing_datagram_stream_subscribe(p0 : Int) -> Int = "wasi:sockets/udp@0.2.9" "[method]outgoing-datagram-stream.subscribe"

///| High-level wrapper with canonical ABI conversion
pub fn outgoing_datagram_stream_subscribe(handle : OutgoingDatagramStream) -> @poll.Pollable {
  let result = ffi_outgoing_datagram_stream_subscribe(handle.0)
  @poll.Pollable(result)
}

///| Low-level FFI import
fn ffi_udp_socket_address_family(p0 : Int) -> Int = "wasi:sockets/udp@0.2.9" "[method]udp-socket.address-family"

///| High-level wrapper with canonical ABI conversion
pub fn udp_socket_address_family(handle : UdpSocket) -> IpAddressFamily {
  let result = ffi_udp_socket_address_family(handle.0)
  IpAddressFamily::from_ordinal(result)
}

///| Low-level FFI import
fn ffi_udp_socket_finish_bind(p0 : Int, retptr : Int) -> Int = "wasi:sockets/udp@0.2.9" "[method]udp-socket.finish-bind"

///| High-level wrapper with canonical ABI conversion
pub fn udp_socket_finish_bind(handle : UdpSocket) -> Result[Unit, ErrorCode] {
  let retptr = @cabi.cabi_realloc(0, 0, 4, 8)
  let _ = ffi_udp_socket_finish_bind(handle.0, retptr)
  match @cabi.cabi_read_i32(retptr) {
    0 => Ok(())
    _ => Err(ErrorCode::from_ordinal(@cabi.cabi_read_i32(retptr + 4)))
  }
}

///| Low-level FFI import
fn ffi_udp_socket_local_address(p0 : Int, retptr : Int) -> Int = "wasi:sockets/udp@0.2.9" "[method]udp-socket.local-address"

///| High-level wrapper with canonical ABI conversion
pub fn udp_socket_local_address(handle : UdpSocket) -> Result[IpSocketAddress, ErrorCode] {
  let retptr = @cabi.cabi_realloc(0, 0, 4, 36)
  let _ = ffi_udp_socket_local_address(handle.0, retptr)
  match @cabi.cabi_read_i32(retptr) {
    0 => {
      // TODO: lift IpSocketAddress properly
      abort("udp_socket_local_address: lift IpSocketAddress not implemented")
    }
    _ => Err(ErrorCode::from_ordinal(@cabi.cabi_read_i32(retptr + 4)))
  }
}

///| Low-level FFI import
fn ffi_udp_socket_receive_buffer_size(p0 : Int, retptr : Int) -> Int = "wasi:sockets/udp@0.2.9" "[method]udp-socket.receive-buffer-size"

///| High-level wrapper with canonical ABI conversion
pub fn udp_socket_receive_buffer_size(handle : UdpSocket) -> Result[UInt64, ErrorCode] {
  let retptr = @cabi.cabi_realloc(0, 0, 4, 12)
  let _ = ffi_udp_socket_receive_buffer_size(handle.0, retptr)
  match @cabi.cabi_read_i32(retptr) {
    0 => Ok(@cabi.cabi_read_i64(retptr + 4).reinterpret_as_uint64())
    _ => Err(ErrorCode::from_ordinal(@cabi.cabi_read_i32(retptr + 4)))
  }
}

///| Low-level FFI import
fn ffi_udp_socket_remote_address(p0 : Int, retptr : Int) -> Int = "wasi:sockets/udp@0.2.9" "[method]udp-socket.remote-address"

///| High-level wrapper with canonical ABI conversion
pub fn udp_socket_remote_address(handle : UdpSocket) -> Result[IpSocketAddress, ErrorCode] {
  let retptr = @cabi.cabi_realloc(0, 0, 4, 36)
  let _ = ffi_udp_socket_remote_address(handle.0, retptr)
  match @cabi.cabi_read_i32(retptr) {
    0 => {
      // TODO: lift IpSocketAddress properly
      abort("udp_socket_remote_address: lift IpSocketAddress not implemented")
    }
    _ => Err(ErrorCode::from_ordinal(@cabi.cabi_read_i32(retptr + 4)))
  }
}

///| Low-level FFI import
fn ffi_udp_socket_send_buffer_size(p0 : Int, retptr : Int) -> Int = "wasi:sockets/udp@0.2.9" "[method]udp-socket.send-buffer-size"

///| High-level wrapper with canonical ABI conversion
pub fn udp_socket_send_buffer_size(handle : UdpSocket) -> Result[UInt64, ErrorCode] {
  let retptr = @cabi.cabi_realloc(0, 0, 4, 12)
  let _ = ffi_udp_socket_send_buffer_size(handle.0, retptr)
  match @cabi.cabi_read_i32(retptr) {
    0 => Ok(@cabi.cabi_read_i64(retptr + 4).reinterpret_as_uint64())
    _ => Err(ErrorCode::from_ordinal(@cabi.cabi_read_i32(retptr + 4)))
  }
}

///| Low-level FFI import
fn ffi_udp_socket_set_receive_buffer_size(p0 : Int, p1 : Int64, retptr : Int) -> Int = "wasi:sockets/udp@0.2.9" "[method]udp-socket.set-receive-buffer-size"

///| High-level wrapper with canonical ABI conversion
pub fn udp_socket_set_receive_buffer_size(handle : UdpSocket, value : UInt64) -> Result[Unit, ErrorCode] {
  let retptr = @cabi.cabi_realloc(0, 0, 4, 8)
  let _ = ffi_udp_socket_set_receive_buffer_size(handle.0, value.reinterpret_as_int64(), retptr)
  match @cabi.cabi_read_i32(retptr) {
    0 => Ok(())
    _ => Err(ErrorCode::from_ordinal(@cabi.cabi_read_i32(retptr + 4)))
  }
}

///| Low-level FFI import
fn ffi_udp_socket_set_send_buffer_size(p0 : Int, p1 : Int64, retptr : Int) -> Int = "wasi:sockets/udp@0.2.9" "[method]udp-socket.set-send-buffer-size"

///| High-level wrapper with canonical ABI conversion
pub fn udp_socket_set_send_buffer_size(handle : UdpSocket, value : UInt64) -> Result[Unit, ErrorCode] {
  let retptr = @cabi.cabi_realloc(0, 0, 4, 8)
  let _ = ffi_udp_socket_set_send_buffer_size(handle.0, value.reinterpret_as_int64(), retptr)
  match @cabi.cabi_read_i32(retptr) {
    0 => Ok(())
    _ => Err(ErrorCode::from_ordinal(@cabi.cabi_read_i32(retptr + 4)))
  }
}

///| Low-level FFI import
fn ffi_udp_socket_set_unicast_hop_limit(p0 : Int, p1 : Int, retptr : Int) -> Int = "wasi:sockets/udp@0.2.9" "[method]udp-socket.set-unicast-hop-limit"

///| High-level wrapper with canonical ABI conversion
pub fn udp_socket_set_unicast_hop_limit(handle : UdpSocket, value : Byte) -> Result[Unit, ErrorCode] {
  let retptr = @cabi.cabi_realloc(0, 0, 4, 8)
  let _ = ffi_udp_socket_set_unicast_hop_limit(handle.0, value.to_int(), retptr)
  match @cabi.cabi_read_i32(retptr) {
    0 => Ok(())
    _ => Err(ErrorCode::from_ordinal(@cabi.cabi_read_i32(retptr + 4)))
  }
}

///| Low-level FFI import
fn ffi_udp_socket_start_bind(p0 : Int, p1 : Int, p2 : Int, retptr : Int) -> Int = "wasi:sockets/udp@0.2.9" "[method]udp-socket.start-bind"

///| High-level wrapper with canonical ABI conversion
pub fn udp_socket_start_bind(handle : UdpSocket, network : @network.Network, local_address : IpSocketAddress) -> Result[Unit, ErrorCode] {
  let retptr = @cabi.cabi_realloc(0, 0, 4, 8)
  // TODO: lower IpSocketAddress properly
  ignore(local_address)
  let _ = ffi_udp_socket_start_bind(handle.0, network.0, 0, retptr)
  match @cabi.cabi_read_i32(retptr) {
    0 => Ok(())
    _ => Err(ErrorCode::from_ordinal(@cabi.cabi_read_i32(retptr + 4)))
  }
}

///| Low-level FFI import
fn ffi_udp_socket_stream(p0 : Int, p1 : Int, retptr : Int) -> Int = "wasi:sockets/udp@0.2.9" "[method]udp-socket.stream"

///| High-level wrapper with canonical ABI conversion
pub fn udp_socket_stream(handle : UdpSocket, remote_address : IpSocketAddress?) -> Result[(IncomingDatagramStream, OutgoingDatagramStream), ErrorCode] {
  let p1_ptr = @cabi.cabi_realloc(0, 0, 4, 4 + 4)
  match remote_address {
    Some(_val) => {
      @cabi.cabi_write_i32(p1_ptr, 1)
      // TODO: lower nested type val
    }
    None => @cabi.cabi_write_i32(p1_ptr, 0)
  }
  let retptr = @cabi.cabi_realloc(0, 0, 4, 12)
  let _ = ffi_udp_socket_stream(handle.0, p1_ptr, retptr)
  match @cabi.cabi_read_i32(retptr) {
    0 => Ok((IncomingDatagramStream(@cabi.cabi_read_i32(retptr + 4)), OutgoingDatagramStream(@cabi.cabi_read_i32(retptr + 8))))
    _ => Err(ErrorCode::from_ordinal(@cabi.cabi_read_i32(retptr + 4)))
  }
}

///| Low-level FFI import
fn ffi_udp_socket_subscribe(p0 : Int) -> Int = "wasi:sockets/udp@0.2.9" "[method]udp-socket.subscribe"

///| High-level wrapper with canonical ABI conversion
pub fn udp_socket_subscribe(handle : UdpSocket) -> @poll.Pollable {
  let result = ffi_udp_socket_subscribe(handle.0)
  @poll.Pollable(result)
}

///| Low-level FFI import
fn ffi_udp_socket_unicast_hop_limit(p0 : Int, retptr : Int) -> Int = "wasi:sockets/udp@0.2.9" "[method]udp-socket.unicast-hop-limit"

///| High-level wrapper with canonical ABI conversion
pub fn udp_socket_unicast_hop_limit(handle : UdpSocket) -> Result[Byte, ErrorCode] {
  let retptr = @cabi.cabi_realloc(0, 0, 4, 8)
  let _ = ffi_udp_socket_unicast_hop_limit(handle.0, retptr)
  match @cabi.cabi_read_i32(retptr) {
    0 => Ok(@cabi.cabi_read_u8(retptr + 4))
    _ => Err(ErrorCode::from_ordinal(@cabi.cabi_read_i32(retptr + 4)))
  }
}
