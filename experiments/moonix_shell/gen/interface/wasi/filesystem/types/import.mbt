// Generated by moon-component
// Import module: wasi:filesystem/types@0.2.9

type Filesize = UInt64

type LinkCount = UInt64

type Datetime = @wall_clock.Datetime

///|
pub(all) enum Advice {
  Normal
  Sequential
  Random
  WillNeed
  DontNeed
  NoReuse
} derive(Show, Eq)

///|
pub fn Advice::from_ordinal(ord : Int) -> Advice {
  match ord {
    0 => Normal
    1 => Sequential
    2 => Random
    3 => WillNeed
    4 => DontNeed
    5 => NoReuse
    _ => abort("invalid ordinal")
  }
}

///|
pub fn Advice::ordinal(self : Advice) -> Int {
  match self {
    Normal => 0
    Sequential => 1
    Random => 2
    WillNeed => 3
    DontNeed => 4
    NoReuse => 5
  }
}

///|
pub(all) struct Descriptor(Int) derive(Show, Eq)

///|
pub(all) enum DescriptorFlags {
  Read
  Write
  FileIntegritySync
  DataIntegritySync
  RequestedWriteSync
  MutateDirectory
  DescriptorFlagsBits(UInt)
} derive(Show, Eq)

///|
pub fn DescriptorFlags::from_bits(bits : Int) -> DescriptorFlags {
  DescriptorFlagsBits(bits.reinterpret_as_uint())
}

///|
pub fn DescriptorFlags::to_bits(self : DescriptorFlags) -> Int {
  match self {
    Read => 1
    Write => 2
    FileIntegritySync => 4
    DataIntegritySync => 8
    RequestedWriteSync => 16
    MutateDirectory => 32
    DescriptorFlagsBits(bits) => bits.reinterpret_as_int()
  }
}

///|
pub(all) struct DescriptorStat {
  type_ : DescriptorType
  link_count : LinkCount
  size : Filesize
  data_access_timestamp : Datetime?
  data_modification_timestamp : Datetime?
  status_change_timestamp : Datetime?
} derive(Show, Eq)

///|
pub(all) enum DescriptorType {
  Unknown
  BlockDevice
  CharacterDevice
  Directory
  Fifo
  SymbolicLink
  RegularFile
  Socket
} derive(Show, Eq)

///|
pub fn DescriptorType::from_ordinal(ord : Int) -> DescriptorType {
  match ord {
    0 => Unknown
    1 => BlockDevice
    2 => CharacterDevice
    3 => Directory
    4 => Fifo
    5 => SymbolicLink
    6 => RegularFile
    7 => Socket
    _ => abort("invalid ordinal")
  }
}

///|
pub fn DescriptorType::ordinal(self : DescriptorType) -> Int {
  match self {
    Unknown => 0
    BlockDevice => 1
    CharacterDevice => 2
    Directory => 3
    Fifo => 4
    SymbolicLink => 5
    RegularFile => 6
    Socket => 7
  }
}

///|
pub(all) struct DirectoryEntry {
  type_ : DescriptorType
  name : String
} derive(Show, Eq)

///|
pub(all) struct DirectoryEntryStream(Int) derive(Show, Eq)

///|
pub(all) enum ErrorCode {
  Access
  WouldBlock
  Already
  BadDescriptor
  Busy
  Deadlock
  Quota
  Exist
  FileTooLarge
  IllegalByteSequence
  InProgress
  Interrupted
  Invalid
  Io
  IsDirectory
  Loop
  TooManyLinks
  MessageSize
  NameTooLong
  NoDevice
  NoEntry
  NoLock
  InsufficientMemory
  InsufficientSpace
  NotDirectory
  NotEmpty
  NotRecoverable
  Unsupported
  NoTty
  NoSuchDevice
  Overflow
  NotPermitted
  Pipe
  ReadOnly
  InvalidSeek
  TextFileBusy
  CrossDevice
} derive(Show, Eq)

///|
pub fn ErrorCode::from_ordinal(ord : Int) -> ErrorCode {
  match ord {
    0 => Access
    1 => WouldBlock
    2 => Already
    3 => BadDescriptor
    4 => Busy
    5 => Deadlock
    6 => Quota
    7 => Exist
    8 => FileTooLarge
    9 => IllegalByteSequence
    10 => InProgress
    11 => Interrupted
    12 => Invalid
    13 => Io
    14 => IsDirectory
    15 => Loop
    16 => TooManyLinks
    17 => MessageSize
    18 => NameTooLong
    19 => NoDevice
    20 => NoEntry
    21 => NoLock
    22 => InsufficientMemory
    23 => InsufficientSpace
    24 => NotDirectory
    25 => NotEmpty
    26 => NotRecoverable
    27 => Unsupported
    28 => NoTty
    29 => NoSuchDevice
    30 => Overflow
    31 => NotPermitted
    32 => Pipe
    33 => ReadOnly
    34 => InvalidSeek
    35 => TextFileBusy
    36 => CrossDevice
    _ => abort("invalid ordinal")
  }
}

///|
pub fn ErrorCode::ordinal(self : ErrorCode) -> Int {
  match self {
    Access => 0
    WouldBlock => 1
    Already => 2
    BadDescriptor => 3
    Busy => 4
    Deadlock => 5
    Quota => 6
    Exist => 7
    FileTooLarge => 8
    IllegalByteSequence => 9
    InProgress => 10
    Interrupted => 11
    Invalid => 12
    Io => 13
    IsDirectory => 14
    Loop => 15
    TooManyLinks => 16
    MessageSize => 17
    NameTooLong => 18
    NoDevice => 19
    NoEntry => 20
    NoLock => 21
    InsufficientMemory => 22
    InsufficientSpace => 23
    NotDirectory => 24
    NotEmpty => 25
    NotRecoverable => 26
    Unsupported => 27
    NoTty => 28
    NoSuchDevice => 29
    Overflow => 30
    NotPermitted => 31
    Pipe => 32
    ReadOnly => 33
    InvalidSeek => 34
    TextFileBusy => 35
    CrossDevice => 36
  }
}

///|
pub(all) struct MetadataHashValue {
  lower : UInt64
  upper : UInt64
} derive(Show, Eq)

///|
pub(all) enum NewTimestamp {
  NoChange
  Now
  Timestamp(Datetime)
} derive(Show, Eq)

///|
pub(all) struct OpenFlags {
  bits : UInt
} derive(Show, Eq)

///|
pub fn OpenFlags::from_bits(bits : Int) -> OpenFlags {
  { bits: bits.reinterpret_as_uint() }
}

///|
pub fn OpenFlags::to_bits(self : OpenFlags) -> Int {
  self.bits.reinterpret_as_int()
}

///|
pub let create : OpenFlags = { bits: 1 }

///|
pub let open_directory : OpenFlags = { bits: 2 }

///|
pub let exclusive : OpenFlags = { bits: 4 }

///|
pub let truncate : OpenFlags = { bits: 8 }

///|
pub(all) enum PathFlags {
  SymlinkFollow
  PathFlagsBits(UInt)
} derive(Show, Eq)

///|
pub fn PathFlags::from_bits(bits : Int) -> PathFlags {
  PathFlagsBits(bits.reinterpret_as_uint())
}

///|
pub fn PathFlags::to_bits(self : PathFlags) -> Int {
  match self {
    SymlinkFollow => 1
    PathFlagsBits(bits) => bits.reinterpret_as_int()
  }
}

///| Low-level FFI import
fn ffi_descriptor_advise(p0 : Int, p1 : Int64, p2 : Int64, p3 : Int, retptr : Int) -> Int = "wasi:filesystem/types@0.2.9" "[method]descriptor.advise"

///| High-level wrapper with canonical ABI conversion
pub fn descriptor_advise(handle : Descriptor, offset : Filesize, length : Filesize, advice : Advice) -> Result[Unit, ErrorCode] {
  let retptr = @cabi.cabi_realloc(0, 0, 4, 8)
  let _ = ffi_descriptor_advise(handle.0, offset.reinterpret_as_int64(), length.reinterpret_as_int64(), advice.ordinal(), retptr)
  match @cabi.cabi_read_i32(retptr) {
    0 => Ok(())
    _ => Err(ErrorCode::from_ordinal(@cabi.cabi_read_i32(retptr + 4)))
  }
}

///| Low-level FFI import
fn ffi_descriptor_append_via_stream(p0 : Int, retptr : Int) -> Int = "wasi:filesystem/types@0.2.9" "[method]descriptor.append-via-stream"

///| High-level wrapper with canonical ABI conversion
pub fn descriptor_append_via_stream(handle : Descriptor) -> Result[@streams.OutputStream, ErrorCode] {
  let retptr = @cabi.cabi_realloc(0, 0, 4, 8)
  let _ = ffi_descriptor_append_via_stream(handle.0, retptr)
  match @cabi.cabi_read_i32(retptr) {
    0 => Ok(@streams.OutputStream(@cabi.cabi_read_i32(retptr + 4)))
    _ => Err(ErrorCode::from_ordinal(@cabi.cabi_read_i32(retptr + 4)))
  }
}

///| Low-level FFI import
fn ffi_descriptor_create_directory_at(p0 : Int, p1_ptr : Int, p1_len : Int, retptr : Int) -> Int = "wasi:filesystem/types@0.2.9" "[method]descriptor.create-directory-at"

///| High-level wrapper with canonical ABI conversion
pub fn descriptor_create_directory_at(handle : Descriptor, path : String) -> Result[Unit, ErrorCode] {
  let (p1_ptr, p1_len) = @cabi.cabi_lower_string(path)
  let retptr = @cabi.cabi_realloc(0, 0, 4, 8)
  let _ = ffi_descriptor_create_directory_at(handle.0, p1_ptr, p1_len, retptr)
  match @cabi.cabi_read_i32(retptr) {
    0 => Ok(())
    _ => Err(ErrorCode::from_ordinal(@cabi.cabi_read_i32(retptr + 4)))
  }
}

///| Low-level FFI import
fn ffi_descriptor_get_flags(p0 : Int, retptr : Int) -> Int = "wasi:filesystem/types@0.2.9" "[method]descriptor.get-flags"

///| High-level wrapper with canonical ABI conversion
pub fn descriptor_get_flags(handle : Descriptor) -> Result[DescriptorFlags, ErrorCode] {
  let retptr = @cabi.cabi_realloc(0, 0, 4, 8)
  let _ = ffi_descriptor_get_flags(handle.0, retptr)
  match @cabi.cabi_read_i32(retptr) {
    0 => Ok(DescriptorFlags::from_bits(@cabi.cabi_read_i32(retptr + 4)))
    _ => Err(ErrorCode::from_ordinal(@cabi.cabi_read_i32(retptr + 4)))
  }
}

///| Low-level FFI import
fn ffi_descriptor_get_type(p0 : Int, retptr : Int) -> Int = "wasi:filesystem/types@0.2.9" "[method]descriptor.get-type"

///| High-level wrapper with canonical ABI conversion
pub fn descriptor_get_type(handle : Descriptor) -> Result[DescriptorType, ErrorCode] {
  let retptr = @cabi.cabi_realloc(0, 0, 4, 8)
  let _ = ffi_descriptor_get_type(handle.0, retptr)
  match @cabi.cabi_read_i32(retptr) {
    0 => Ok(DescriptorType::from_ordinal(@cabi.cabi_read_i32(retptr + 4)))
    _ => Err(ErrorCode::from_ordinal(@cabi.cabi_read_i32(retptr + 4)))
  }
}

///| Low-level FFI import
fn ffi_descriptor_is_same_object(p0 : Int, p1 : Int) -> Int = "wasi:filesystem/types@0.2.9" "[method]descriptor.is-same-object"

///| High-level wrapper with canonical ABI conversion
pub fn descriptor_is_same_object(handle : Descriptor, other : Descriptor) -> Bool {
  let result = ffi_descriptor_is_same_object(handle.0, other.0)
  result != 0
}

///| Low-level FFI import
fn ffi_descriptor_link_at(p0 : Int, p1 : Int, p2_ptr : Int, p2_len : Int, p3 : Int, p4_ptr : Int, p4_len : Int, retptr : Int) -> Int = "wasi:filesystem/types@0.2.9" "[method]descriptor.link-at"

///| High-level wrapper with canonical ABI conversion
pub fn descriptor_link_at(handle : Descriptor, old_path_flags : PathFlags, old_path : String, new_descriptor : Descriptor, new_path : String) -> Result[Unit, ErrorCode] {
  let (p2_ptr, p2_len) = @cabi.cabi_lower_string(old_path)
  let (p4_ptr, p4_len) = @cabi.cabi_lower_string(new_path)
  let retptr = @cabi.cabi_realloc(0, 0, 4, 8)
  let _ = ffi_descriptor_link_at(handle.0, old_path_flags.to_bits(), p2_ptr, p2_len, new_descriptor.0, p4_ptr, p4_len, retptr)
  match @cabi.cabi_read_i32(retptr) {
    0 => Ok(())
    _ => Err(ErrorCode::from_ordinal(@cabi.cabi_read_i32(retptr + 4)))
  }
}

///| Low-level FFI import
fn ffi_descriptor_metadata_hash(p0 : Int, retptr : Int) -> Int = "wasi:filesystem/types@0.2.9" "[method]descriptor.metadata-hash"

///| High-level wrapper with canonical ABI conversion
pub fn descriptor_metadata_hash(handle : Descriptor) -> Result[MetadataHashValue, ErrorCode] {
  let retptr = @cabi.cabi_realloc(0, 0, 4, 20)
  let _ = ffi_descriptor_metadata_hash(handle.0, retptr)
  match @cabi.cabi_read_i32(retptr) {
    0 => Ok(({ lower: @cabi.cabi_read_i64(retptr + 4).reinterpret_as_uint64(), upper: @cabi.cabi_read_i64(retptr + 4 + 8).reinterpret_as_uint64() } : MetadataHashValue))
    _ => Err(ErrorCode::from_ordinal(@cabi.cabi_read_i32(retptr + 4)))
  }
}

///| Low-level FFI import
fn ffi_descriptor_metadata_hash_at(p0 : Int, p1 : Int, p2_ptr : Int, p2_len : Int, retptr : Int) -> Int = "wasi:filesystem/types@0.2.9" "[method]descriptor.metadata-hash-at"

///| High-level wrapper with canonical ABI conversion
pub fn descriptor_metadata_hash_at(handle : Descriptor, path_flags : PathFlags, path : String) -> Result[MetadataHashValue, ErrorCode] {
  let (p2_ptr, p2_len) = @cabi.cabi_lower_string(path)
  let retptr = @cabi.cabi_realloc(0, 0, 4, 20)
  let _ = ffi_descriptor_metadata_hash_at(handle.0, path_flags.to_bits(), p2_ptr, p2_len, retptr)
  match @cabi.cabi_read_i32(retptr) {
    0 => Ok(({ lower: @cabi.cabi_read_i64(retptr + 4).reinterpret_as_uint64(), upper: @cabi.cabi_read_i64(retptr + 4 + 8).reinterpret_as_uint64() } : MetadataHashValue))
    _ => Err(ErrorCode::from_ordinal(@cabi.cabi_read_i32(retptr + 4)))
  }
}

///| Low-level FFI import
fn ffi_descriptor_open_at(p0 : Int, p1 : Int, p2_ptr : Int, p2_len : Int, p3 : Int, p4 : Int, retptr : Int) -> Int = "wasi:filesystem/types@0.2.9" "[method]descriptor.open-at"

///| High-level wrapper with canonical ABI conversion
pub fn descriptor_open_at(handle : Descriptor, path_flags : PathFlags, path : String, open_flags : OpenFlags, flags : DescriptorFlags) -> Result[Descriptor, ErrorCode] {
  let (p2_ptr, p2_len) = @cabi.cabi_lower_string(path)
  let retptr = @cabi.cabi_realloc(0, 0, 4, 8)
  let _ = ffi_descriptor_open_at(handle.0, path_flags.to_bits(), p2_ptr, p2_len, open_flags.to_bits(), flags.to_bits(), retptr)
  match @cabi.cabi_read_i32(retptr) {
    0 => Ok(Descriptor(@cabi.cabi_read_i32(retptr + 4)))
    _ => Err(ErrorCode::from_ordinal(@cabi.cabi_read_i32(retptr + 4)))
  }
}

///| Low-level FFI import
fn ffi_descriptor_read(p0 : Int, p1 : Int64, p2 : Int64, retptr : Int) -> Int = "wasi:filesystem/types@0.2.9" "[method]descriptor.read"

///| High-level wrapper with canonical ABI conversion
pub fn descriptor_read(handle : Descriptor, length : Filesize, offset : Filesize) -> Result[(Array[Byte], Bool), ErrorCode] {
  let retptr = @cabi.cabi_realloc(0, 0, 4, 13)
  let _ = ffi_descriptor_read(handle.0, length.reinterpret_as_int64(), offset.reinterpret_as_int64(), retptr)
  match @cabi.cabi_read_i32(retptr) {
    0 => {
      let data_ptr = @cabi.cabi_read_i32(retptr + 4)
      let data_len = @cabi.cabi_read_i32(retptr + 8)
      let bytes : Array[Byte] = Array::new(capacity=data_len)
      for i in 0..<data_len {
        bytes.push(@cabi.cabi_read_u8(data_ptr + i))
      }
      let eof = @cabi.cabi_read_i32(retptr + 12) != 0
      Ok((bytes, eof))
    }
    _ => Err(ErrorCode::from_ordinal(@cabi.cabi_read_i32(retptr + 4)))
  }
}

///| Low-level FFI import
fn ffi_descriptor_read_directory(p0 : Int, retptr : Int) -> Int = "wasi:filesystem/types@0.2.9" "[method]descriptor.read-directory"

///| High-level wrapper with canonical ABI conversion
pub fn descriptor_read_directory(handle : Descriptor) -> Result[DirectoryEntryStream, ErrorCode] {
  let retptr = @cabi.cabi_realloc(0, 0, 4, 8)
  let _ = ffi_descriptor_read_directory(handle.0, retptr)
  match @cabi.cabi_read_i32(retptr) {
    0 => Ok(DirectoryEntryStream(@cabi.cabi_read_i32(retptr + 4)))
    _ => Err(ErrorCode::from_ordinal(@cabi.cabi_read_i32(retptr + 4)))
  }
}

///| Low-level FFI import
fn ffi_descriptor_read_via_stream(p0 : Int, p1 : Int64, retptr : Int) -> Int = "wasi:filesystem/types@0.2.9" "[method]descriptor.read-via-stream"

///| High-level wrapper with canonical ABI conversion
pub fn descriptor_read_via_stream(handle : Descriptor, offset : Filesize) -> Result[@streams.InputStream, ErrorCode] {
  let retptr = @cabi.cabi_realloc(0, 0, 4, 8)
  let _ = ffi_descriptor_read_via_stream(handle.0, offset.reinterpret_as_int64(), retptr)
  match @cabi.cabi_read_i32(retptr) {
    0 => Ok(@streams.InputStream(@cabi.cabi_read_i32(retptr + 4)))
    _ => Err(ErrorCode::from_ordinal(@cabi.cabi_read_i32(retptr + 4)))
  }
}

///| Low-level FFI import
fn ffi_descriptor_readlink_at(p0 : Int, p1_ptr : Int, p1_len : Int, retptr : Int) -> Int = "wasi:filesystem/types@0.2.9" "[method]descriptor.readlink-at"

///| High-level wrapper with canonical ABI conversion
pub fn descriptor_readlink_at(handle : Descriptor, path : String) -> Result[String, ErrorCode] {
  let (p1_ptr, p1_len) = @cabi.cabi_lower_string(path)
  let retptr = @cabi.cabi_realloc(0, 0, 4, 12)
  let _ = ffi_descriptor_readlink_at(handle.0, p1_ptr, p1_len, retptr)
  match @cabi.cabi_read_i32(retptr) {
    0 => Ok(@cabi.cabi_lift_string(@cabi.cabi_read_i32(retptr + 4), @cabi.cabi_read_i32(retptr + 4 + 4)))
    _ => Err(ErrorCode::from_ordinal(@cabi.cabi_read_i32(retptr + 4)))
  }
}

///| Low-level FFI import
fn ffi_descriptor_remove_directory_at(p0 : Int, p1_ptr : Int, p1_len : Int, retptr : Int) -> Int = "wasi:filesystem/types@0.2.9" "[method]descriptor.remove-directory-at"

///| High-level wrapper with canonical ABI conversion
pub fn descriptor_remove_directory_at(handle : Descriptor, path : String) -> Result[Unit, ErrorCode] {
  let (p1_ptr, p1_len) = @cabi.cabi_lower_string(path)
  let retptr = @cabi.cabi_realloc(0, 0, 4, 8)
  let _ = ffi_descriptor_remove_directory_at(handle.0, p1_ptr, p1_len, retptr)
  match @cabi.cabi_read_i32(retptr) {
    0 => Ok(())
    _ => Err(ErrorCode::from_ordinal(@cabi.cabi_read_i32(retptr + 4)))
  }
}

///| Low-level FFI import
fn ffi_descriptor_rename_at(p0 : Int, p1_ptr : Int, p1_len : Int, p2 : Int, p3_ptr : Int, p3_len : Int, retptr : Int) -> Int = "wasi:filesystem/types@0.2.9" "[method]descriptor.rename-at"

///| High-level wrapper with canonical ABI conversion
pub fn descriptor_rename_at(handle : Descriptor, old_path : String, new_descriptor : Descriptor, new_path : String) -> Result[Unit, ErrorCode] {
  let (p1_ptr, p1_len) = @cabi.cabi_lower_string(old_path)
  let (p3_ptr, p3_len) = @cabi.cabi_lower_string(new_path)
  let retptr = @cabi.cabi_realloc(0, 0, 4, 8)
  let _ = ffi_descriptor_rename_at(handle.0, p1_ptr, p1_len, new_descriptor.0, p3_ptr, p3_len, retptr)
  match @cabi.cabi_read_i32(retptr) {
    0 => Ok(())
    _ => Err(ErrorCode::from_ordinal(@cabi.cabi_read_i32(retptr + 4)))
  }
}

///| Low-level FFI import
fn ffi_descriptor_set_size(p0 : Int, p1 : Int64, retptr : Int) -> Int = "wasi:filesystem/types@0.2.9" "[method]descriptor.set-size"

///| High-level wrapper with canonical ABI conversion
pub fn descriptor_set_size(handle : Descriptor, size : Filesize) -> Result[Unit, ErrorCode] {
  let retptr = @cabi.cabi_realloc(0, 0, 4, 8)
  let _ = ffi_descriptor_set_size(handle.0, size.reinterpret_as_int64(), retptr)
  match @cabi.cabi_read_i32(retptr) {
    0 => Ok(())
    _ => Err(ErrorCode::from_ordinal(@cabi.cabi_read_i32(retptr + 4)))
  }
}

///| Low-level FFI import
fn ffi_descriptor_set_times(p0 : Int, p1 : Int, p2 : Int, retptr : Int) -> Int = "wasi:filesystem/types@0.2.9" "[method]descriptor.set-times"

///| High-level wrapper with canonical ABI conversion
pub fn descriptor_set_times(handle : Descriptor, data_access_timestamp : NewTimestamp, data_modification_timestamp : NewTimestamp) -> Result[Unit, ErrorCode] {
  let p1_ptr = @cabi.cabi_realloc(0, 0, 4, 8)
  match data_access_timestamp {
    NoChange => {
      @cabi.cabi_write_i32(p1_ptr, 0)
    }
    Now => {
      @cabi.cabi_write_i32(p1_ptr, 1)
    }
    Timestamp(val) => {
      @cabi.cabi_write_i32(p1_ptr, 2)
      // TODO: lower nested type val
    }
  }
  let p2_ptr = @cabi.cabi_realloc(0, 0, 4, 8)
  match data_modification_timestamp {
    NoChange => {
      @cabi.cabi_write_i32(p2_ptr, 0)
    }
    Now => {
      @cabi.cabi_write_i32(p2_ptr, 1)
    }
    Timestamp(val) => {
      @cabi.cabi_write_i32(p2_ptr, 2)
      // TODO: lower nested type val
    }
  }
  let retptr = @cabi.cabi_realloc(0, 0, 4, 8)
  let _ = ffi_descriptor_set_times(handle.0, p1_ptr, p2_ptr, retptr)
  match @cabi.cabi_read_i32(retptr) {
    0 => Ok(())
    _ => Err(ErrorCode::from_ordinal(@cabi.cabi_read_i32(retptr + 4)))
  }
}

///| Low-level FFI import
fn ffi_descriptor_set_times_at(p0 : Int, p1 : Int, p2_ptr : Int, p2_len : Int, p3 : Int, p4 : Int, retptr : Int) -> Int = "wasi:filesystem/types@0.2.9" "[method]descriptor.set-times-at"

///| High-level wrapper with canonical ABI conversion
pub fn descriptor_set_times_at(handle : Descriptor, path_flags : PathFlags, path : String, data_access_timestamp : NewTimestamp, data_modification_timestamp : NewTimestamp) -> Result[Unit, ErrorCode] {
  let (p2_ptr, p2_len) = @cabi.cabi_lower_string(path)
  let p3_ptr = @cabi.cabi_realloc(0, 0, 4, 8)
  match data_access_timestamp {
    NoChange => {
      @cabi.cabi_write_i32(p3_ptr, 0)
    }
    Now => {
      @cabi.cabi_write_i32(p3_ptr, 1)
    }
    Timestamp(val) => {
      @cabi.cabi_write_i32(p3_ptr, 2)
      // TODO: lower nested type val
    }
  }
  let p4_ptr = @cabi.cabi_realloc(0, 0, 4, 8)
  match data_modification_timestamp {
    NoChange => {
      @cabi.cabi_write_i32(p4_ptr, 0)
    }
    Now => {
      @cabi.cabi_write_i32(p4_ptr, 1)
    }
    Timestamp(val) => {
      @cabi.cabi_write_i32(p4_ptr, 2)
      // TODO: lower nested type val
    }
  }
  let retptr = @cabi.cabi_realloc(0, 0, 4, 8)
  let _ = ffi_descriptor_set_times_at(handle.0, path_flags.to_bits(), p2_ptr, p2_len, p3_ptr, p4_ptr, retptr)
  match @cabi.cabi_read_i32(retptr) {
    0 => Ok(())
    _ => Err(ErrorCode::from_ordinal(@cabi.cabi_read_i32(retptr + 4)))
  }
}

///| Low-level FFI import
fn ffi_descriptor_stat(p0 : Int, retptr : Int) -> Int = "wasi:filesystem/types@0.2.9" "[method]descriptor.stat"

///| High-level wrapper with canonical ABI conversion
pub fn descriptor_stat(handle : Descriptor) -> Result[DescriptorStat, ErrorCode] {
  let retptr = @cabi.cabi_realloc(0, 0, 4, 40)
  let _ = ffi_descriptor_stat(handle.0, retptr)
  match @cabi.cabi_read_i32(retptr) {
    0 => Ok(({ type_: DescriptorType::from_ordinal(@cabi.cabi_read_i32(retptr + 4)), link_count: @cabi.cabi_read_i64(retptr + 8).reinterpret_as_uint64(), size: @cabi.cabi_read_i64(retptr + 16).reinterpret_as_uint64(), data_access_timestamp: None, data_modification_timestamp: None, status_change_timestamp: None } : DescriptorStat))
    _ => Err(ErrorCode::from_ordinal(@cabi.cabi_read_i32(retptr + 4)))
  }
}

///| Low-level FFI import
fn ffi_descriptor_stat_at(p0 : Int, p1 : Int, p2_ptr : Int, p2_len : Int, retptr : Int) -> Int = "wasi:filesystem/types@0.2.9" "[method]descriptor.stat-at"

///| High-level wrapper with canonical ABI conversion
pub fn descriptor_stat_at(handle : Descriptor, path_flags : PathFlags, path : String) -> Result[DescriptorStat, ErrorCode] {
  let (p2_ptr, p2_len) = @cabi.cabi_lower_string(path)
  let retptr = @cabi.cabi_realloc(0, 0, 4, 40)
  let _ = ffi_descriptor_stat_at(handle.0, path_flags.to_bits(), p2_ptr, p2_len, retptr)
  match @cabi.cabi_read_i32(retptr) {
    0 => Ok(({ type_: DescriptorType::from_ordinal(@cabi.cabi_read_i32(retptr + 4)), link_count: @cabi.cabi_read_i64(retptr + 8).reinterpret_as_uint64(), size: @cabi.cabi_read_i64(retptr + 16).reinterpret_as_uint64(), data_access_timestamp: None, data_modification_timestamp: None, status_change_timestamp: None } : DescriptorStat))
    _ => Err(ErrorCode::from_ordinal(@cabi.cabi_read_i32(retptr + 4)))
  }
}

///| Low-level FFI import
fn ffi_descriptor_symlink_at(p0 : Int, p1_ptr : Int, p1_len : Int, p2_ptr : Int, p2_len : Int, retptr : Int) -> Int = "wasi:filesystem/types@0.2.9" "[method]descriptor.symlink-at"

///| High-level wrapper with canonical ABI conversion
pub fn descriptor_symlink_at(handle : Descriptor, old_path : String, new_path : String) -> Result[Unit, ErrorCode] {
  let (p1_ptr, p1_len) = @cabi.cabi_lower_string(old_path)
  let (p2_ptr, p2_len) = @cabi.cabi_lower_string(new_path)
  let retptr = @cabi.cabi_realloc(0, 0, 4, 8)
  let _ = ffi_descriptor_symlink_at(handle.0, p1_ptr, p1_len, p2_ptr, p2_len, retptr)
  match @cabi.cabi_read_i32(retptr) {
    0 => Ok(())
    _ => Err(ErrorCode::from_ordinal(@cabi.cabi_read_i32(retptr + 4)))
  }
}

///| Low-level FFI import
fn ffi_descriptor_sync(p0 : Int, retptr : Int) -> Int = "wasi:filesystem/types@0.2.9" "[method]descriptor.sync"

///| High-level wrapper with canonical ABI conversion
pub fn descriptor_sync(handle : Descriptor) -> Result[Unit, ErrorCode] {
  let retptr = @cabi.cabi_realloc(0, 0, 4, 8)
  let _ = ffi_descriptor_sync(handle.0, retptr)
  match @cabi.cabi_read_i32(retptr) {
    0 => Ok(())
    _ => Err(ErrorCode::from_ordinal(@cabi.cabi_read_i32(retptr + 4)))
  }
}

///| Low-level FFI import
fn ffi_descriptor_sync_data(p0 : Int, retptr : Int) -> Int = "wasi:filesystem/types@0.2.9" "[method]descriptor.sync-data"

///| High-level wrapper with canonical ABI conversion
pub fn descriptor_sync_data(handle : Descriptor) -> Result[Unit, ErrorCode] {
  let retptr = @cabi.cabi_realloc(0, 0, 4, 8)
  let _ = ffi_descriptor_sync_data(handle.0, retptr)
  match @cabi.cabi_read_i32(retptr) {
    0 => Ok(())
    _ => Err(ErrorCode::from_ordinal(@cabi.cabi_read_i32(retptr + 4)))
  }
}

///| Low-level FFI import
fn ffi_descriptor_unlink_file_at(p0 : Int, p1_ptr : Int, p1_len : Int, retptr : Int) -> Int = "wasi:filesystem/types@0.2.9" "[method]descriptor.unlink-file-at"

///| High-level wrapper with canonical ABI conversion
pub fn descriptor_unlink_file_at(handle : Descriptor, path : String) -> Result[Unit, ErrorCode] {
  let (p1_ptr, p1_len) = @cabi.cabi_lower_string(path)
  let retptr = @cabi.cabi_realloc(0, 0, 4, 8)
  let _ = ffi_descriptor_unlink_file_at(handle.0, p1_ptr, p1_len, retptr)
  match @cabi.cabi_read_i32(retptr) {
    0 => Ok(())
    _ => Err(ErrorCode::from_ordinal(@cabi.cabi_read_i32(retptr + 4)))
  }
}

///| Low-level FFI import
fn ffi_descriptor_write(p0 : Int, p1_ptr : Int, p1_len : Int, p2 : Int64, retptr : Int) -> Int = "wasi:filesystem/types@0.2.9" "[method]descriptor.write"

///| High-level wrapper with canonical ABI conversion
pub fn descriptor_write(handle : Descriptor, buffer : Array[Byte], offset : Filesize) -> Result[Filesize, ErrorCode] {
  let p1_len = buffer.length()
  let p1_ptr = @cabi.cabi_realloc(0, 0, 1, p1_len * 1)
  for i, elem in buffer {
    let elem_ptr = p1_ptr + i * 1
    @cabi.cabi_write_u8(elem_ptr, elem)
  }
  let retptr = @cabi.cabi_realloc(0, 0, 4, 12)
  let _ = ffi_descriptor_write(handle.0, p1_ptr, p1_len, offset.reinterpret_as_int64(), retptr)
  match @cabi.cabi_read_i32(retptr) {
    0 => Ok(@cabi.cabi_read_i64(retptr + 4).reinterpret_as_uint64())
    _ => Err(ErrorCode::from_ordinal(@cabi.cabi_read_i32(retptr + 4)))
  }
}

///| Low-level FFI import
fn ffi_descriptor_write_via_stream(p0 : Int, p1 : Int64, retptr : Int) -> Int = "wasi:filesystem/types@0.2.9" "[method]descriptor.write-via-stream"

///| High-level wrapper with canonical ABI conversion
pub fn descriptor_write_via_stream(handle : Descriptor, offset : Filesize) -> Result[@streams.OutputStream, ErrorCode] {
  let retptr = @cabi.cabi_realloc(0, 0, 4, 8)
  let _ = ffi_descriptor_write_via_stream(handle.0, offset.reinterpret_as_int64(), retptr)
  match @cabi.cabi_read_i32(retptr) {
    0 => Ok(@streams.OutputStream(@cabi.cabi_read_i32(retptr + 4)))
    _ => Err(ErrorCode::from_ordinal(@cabi.cabi_read_i32(retptr + 4)))
  }
}

///| Low-level FFI import
fn ffi_directory_entry_stream_read_directory_entry(p0 : Int, retptr : Int) -> Int = "wasi:filesystem/types@0.2.9" "[method]directory-entry-stream.read-directory-entry"

///| High-level wrapper with canonical ABI conversion
pub fn directory_entry_stream_read_directory_entry(handle : DirectoryEntryStream) -> Result[DirectoryEntry?, ErrorCode] {
  let retptr = @cabi.cabi_realloc(0, 0, 4, 20)
  let _ = ffi_directory_entry_stream_read_directory_entry(handle.0, retptr)
  match @cabi.cabi_read_i32(retptr) {
    0 => {
      let opt_tag = @cabi.cabi_read_i32(retptr + 4)
      match opt_tag {
        0 => Ok(None)
        _ => {
          let entry_type = DescriptorType::from_ordinal(@cabi.cabi_read_i32(retptr + 8))
          let name = @cabi.cabi_lift_string(@cabi.cabi_read_i32(retptr + 12), @cabi.cabi_read_i32(retptr + 16))
          let entry : DirectoryEntry = { type_: entry_type, name: name }
          Ok(Some(entry))
        }
      }
    }
    _ => Err(ErrorCode::from_ordinal(@cabi.cabi_read_i32(retptr + 4)))
  }
}

///| Low-level FFI import
fn ffi_filesystem_error_code(p0 : Int, retptr : Int) -> Int = "wasi:filesystem/types@0.2.9" "filesystem-error-code"

///| High-level wrapper with canonical ABI conversion
pub fn filesystem_error_code(err : @error.IoError) -> ErrorCode? {
  let retptr = @cabi.cabi_realloc(0, 0, 4, 8)
  let _ = ffi_filesystem_error_code(err.0, retptr)
  match @cabi.cabi_read_i32(retptr) {
    0 => None
    _ => Some(ErrorCode::from_ordinal(@cabi.cabi_read_i32(retptr + 4)))
  }
}

