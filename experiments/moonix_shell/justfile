default:
    @just --list

build:
    moon build --target wasm --release impl

patch: build
    python3 patch_wasm.py _build/wasm/release/build/impl/impl.wasm impl_patched.wasm

componentize: patch
    ~/.local/bin/moon-component componentize impl_patched.wasm \
        --wit-dir wit -o component.wasm

transpile: componentize
    npx jco transpile component.wasm -o out --instantiation async \
        --map 'wasi:filesystem/types@0.2.9=../../deno_host/virtual_fs.ts#types' \
        --map 'wasi:filesystem/preopens@0.2.9=../../deno_host/virtual_fs.ts#preopens' \
        --map 'wasi:io/streams@0.2.9=../../deno_host/virtual_io.ts#streams' \
        --map 'wasi:io/error@0.2.9=../../deno_host/virtual_io.ts#error' \
        --map 'wasi:io/poll@0.2.9=../../deno_host/virtual_poll.ts#poll' \
        --map 'wasi:cli/stdin@0.2.9=../../deno_host/virtual_cli.ts#stdin' \
        --map 'wasi:cli/stdout@0.2.9=../../deno_host/virtual_cli.ts#stdout' \
        --map 'wasi:cli/stderr@0.2.9=../../deno_host/virtual_cli.ts#stderr' \
        --map 'wasi:cli/environment@0.2.9=../../deno_host/virtual_cli.ts#environment' \
        --map 'wasi:cli/exit@0.2.9=../../deno_host/virtual_cli.ts#exit' \
        --map 'wasi:cli/terminal-input@0.2.9=../../deno_host/virtual_cli.ts#terminalInput' \
        --map 'wasi:cli/terminal-output@0.2.9=../../deno_host/virtual_cli.ts#terminalOutput' \
        --map 'wasi:cli/terminal-stdin@0.2.9=../../deno_host/virtual_cli.ts#terminalStdin' \
        --map 'wasi:cli/terminal-stdout@0.2.9=../../deno_host/virtual_cli.ts#terminalStdout' \
        --map 'wasi:cli/terminal-stderr@0.2.9=../../deno_host/virtual_cli.ts#terminalStderr' \
        --map 'wasi:clocks/wall-clock@0.2.9=../../deno_host/virtual_clock.ts#wallClock' \
        --map 'wasi:clocks/monotonic-clock@0.2.9=../../deno_host/virtual_clock.ts#monotonicClock' \
        --map 'wasi:random/random@0.2.9=../../deno_host/virtual_random.ts#random' \
        --map 'wasi:random/insecure@0.2.9=../../deno_host/virtual_random.ts#insecure' \
        --map 'wasi:random/insecure-seed@0.2.9=../../deno_host/virtual_random.ts#insecureSeed' \
        --map 'wasi:sockets/tcp@0.2.9=../../deno_host/virtual_sockets.ts#tcp' \
        --map 'wasi:sockets/tcp-create-socket@0.2.9=../../deno_host/virtual_sockets.ts#tcpCreateSocket' \
        --map 'wasi:sockets/udp@0.2.9=../../deno_host/virtual_sockets.ts#udp' \
        --map 'wasi:sockets/udp-create-socket@0.2.9=../../deno_host/virtual_sockets.ts#udpCreateSocket' \
        --map 'wasi:sockets/network@0.2.9=../../deno_host/virtual_sockets.ts#network' \
        --map 'wasi:sockets/instance-network@0.2.9=../../deno_host/virtual_sockets.ts#instanceNetwork' \
        --map 'wasi:sockets/ip-name-lookup@0.2.9=../../deno_host/virtual_sockets.ts#ipNameLookup'

all: transpile

clean:
    rm -rf _build component.wasm impl_patched.wasm out .gen.log
